# test_vbaProjectCompiler.py

import pytest, binascii
from vbaProjectCompiler.main import *

def test_constructor():
    expected = "./Fo0"
    project = VbaProject(expected)
    result = project.path
    assert result == expected

def test_getFirstDirectoryChainSector():
    project = VbaProject('.')
    assert project.getFirstDirectoryChainSector() == 1;

def test_header():
    project = VbaProject('.')
    result = project.header()
    expected = b'\xD0\xCF\x11\xE0\xA1\xB1\x1A\xE1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3E\x00\x03\x00\xFE\xFF\x09\x00\x06\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x02\x00\x00\x00\x01\x00\x00\x00\xFE\xFF\xFF\xFF\x00\x00\x00\x00'
    empty = b'\xff\xff\xff\xff'
    emptyLine = empty * 4
    padding = emptyLine * 27
    expected += b'\x00\x00\x00\x00' + padding
    assert result == expected

def test_streamSectors():
    project = VbaProject('.')
    list1 = [7]
    list2 = [4, 5, 6, 8, 16, 9, 10, 11, 12, 13, 14, 15, 17]
    project.addStreamSectorList(list1)
    assert project.countStreams() == 1
    project.addStreamSectorList(list2)
    assert project.countStreams() == 2
    result = project.streamSectors
    assert result == [list1, list2]
    assert project.getFatChainLength() == 17
    assert project.countFatChainSectors() == 1

    result = project.writeFatSectorList()
    empty = b'\xff\xff\xff\xff'
    emptyLine = empty * 4
    padding = emptyLine * 27
    expected = b'\x00\x00\x00\x00' + padding
    assert result == expected
   
    def test_minifat():
        thisWorkbook = b'01 16 03 00 00 F0 00 00 00 D2 02 00 00 D4 00 00  .....d...O...O..
00 00 02 00 00 FF FF FF FF D9 02 00 00 2D 03 00  .........U...-..
00 00 00 00 00 01 00 00 00 F3 08 1C B8 00 00 FF  .........ó..,...
FF 23 01 00 00 88 00 00 00 B6 00 FF FF 01 01 00  .#...?...¶......
00 00 00 FF FF FF FF 00 00 00 00 FF FF FF FF FF  ................
FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00 00 00 00 00 00 00 10 00 00 00 03 00 00 00 05  ................
00 00 00 07 00 00 00 FF FF FF FF FF FF FF FF 01  ................
01 08 00 00 00 FF FF FF FF 78 00 00 00 08 00 00  .........x......
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF  ................
00 00 00 00 4D 45 00 00 FF FF FF FF FF FF 00 00  ....ME..........
00 00 FF FF 00 00 00 00 FF FF 01 01 00 00 00 00  ................
DF 00 FF FF 00 00 00 00 18 00 FF FF FF FF FF FF  ß...............
FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF  ................
FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF  ................
FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF  ................
FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF  ................
00000940   FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF  ................
00000950   FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF  ................
00000960   FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF  ................
00000970   FF FF FF FF FF FF FF FF FF FF 28 00 00 00 02 00  ..........(.....
00000980   53 4C FF FF FF FF 00 00 01 00 53 10 FF FF FF FF  SL........S.....
00000990   00 00 01 00 53 94 FF FF FF FF 00 00 00 00 02 3C  ....S?.........<
000009A0   FF FF FF FF 00 00 FF FF 01 01 00 00 00 00 01 00  ................
000009B0   4E 00 30 00 7B 00 30 00 30 00 30 00 32 00 30 00  N.0.{.0.0.0.2.0.
000009C0   38 00 31 00 39 00 2D 00 30 00 30 00 30 00 30 00  8.1.9.-.0.0.0.0.
2D 00 30 00 30 00 30 00 30 00 2D 00 43 00 30 00  -.0.0.0.0.-.C.0.
30 00 30 00 2D 00 30 00 30 00 30 00 30 00 30 00  0.0.-.0.0.0.0.0.
30 00 30 00 30 00 30 00 30 00 34 00 36 00 7D 00  0.0.0.0.0.4.6.}.
00 00 00 00 00 00 FF FF FF FF 01 01 40 00 00 00  ............@...
02 80 FE FF FF FF FF FF 20 00 00 00 FF FF FF FF  .?_..... .......
30 00 00 00 02 01 FF FF 00 00 00 00 00 00 00 00  0...............
FF FF FF FF FF FF FF FF 00 00 00 00 2E 00 43 00  ..............C.
1D 00 00 00 25 00 00 00 FF FF FF FF 40 00 00 00  ....%.......@...
00 00 FF FF 00 00 01 00 00 00 00 00 00 00 00 00  ................
FF FF FF FF FF FF FF FF FF FF FF FF 00 00 00 00  ................
FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF  ................
FF FF FF FF 00 00 00 00 FF FF FF FF FF FF FF FF  ................
FF FF FF FF FF FF FF FF FF FF FF FF 00 00 00 00  ................
00 00 00 00 FF FF 00 00 FF FF FF FF FF FF 00 00  ................
00 00 FF FF FF FF FF FF FF FF FF FF FF FF FF FF  ................
FF FF FF FF FF FF FF FF FF FF 00 00 FF FF FF FF  ................
FF FF 00 00 00 00 00 00 DF 00 00 00 00 00 00 00  ........ß.......
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00 00 00 00 00 FE CA 01 00 00 00 FF FF FF FF 01  ....._E.........
01 08 00 00 00 FF FF FF FF 78 00 00 00 FF FF FF  .........x......
FF 00 00 01 B0 B0 00 41 74 74 72 69 62 75 74 00  ....°°.Attribut.
65 20 56 42 5F 4E 61 6D 00 65 20 3D 20 22 54 68  e VB_Nam.e = "Th
69 00 73 57 6F 72 6B 62 6F 6F 10 6B 22 0D 0A 0A  i.sWorkboo.k"...
8C 42 61 73 01 02 8C 30 7B 30 30 30 32 30 50 38  ?Bas..?0{00020P8
31 39 2D 00 10 30 03 08 43 07 00 14 02 12 01 24  19-..0..C......$
30 30 34 36 7D 81 0D 7C 47 6C 6F 62 61 6C 01 D0  0046}?.|Global.D
10 53 70 61 63 01 92 46 61 6C 04 73 65 0C 64 43  .Spac.?Fal.se.dC
72 65 61 74 08 61 62 6C 15 1F 50 72 65 64 90 65  reat.abl..Pred?e
63 6C 61 00 06 49 64 00 B1 08 54 72 75 0D 42 45  cla..Id.±.Tru.BE
78 70 6F 04 73 65 14 1C 54 65 6D 70 6C 00 61 74  xpo.se..Templ.at
65 44 65 72 69 76 03 02 12 92 42 75 73 74 6F 6D  eDeriv...?Bustom
69 06 7A 04 44 03 32'
